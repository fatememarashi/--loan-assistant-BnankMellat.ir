<!doctype html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>محاسبه‌گر وام و پس‌انداز (بانک‌یار)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#ef4444" />

  <style>
    :root {
      --bg: #fff;
      --card: #fff;
      --muted: #6b7280;
      --text: #111827;
      --accent: #ef4444;
      --danger: #ef4444;
      --ring: #e5e7eb
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #ef4444;
      --danger: #ef4444;
      --ring: #334155
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%;
      -webkit-text-size-adjust: 100%
    }

    body {
      margin: 0;
      padding: calc(16px + env(safe-area-inset-top)) clamp(8px, 4vw, 16px) calc(16px + env(safe-area-inset-bottom));
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Segoe UI Emoji";
      background: linear-gradient(180deg, var(--bg), #f8fafc 45%, #f1f5f9);
      color: var(--text)
    }

    [data-theme="dark"] body {
      background: linear-gradient(180deg, #0b1025, #0f172a 30%, #0b1025)
    }

    .container {
      max-width: 780px;
      margin: 0 auto
    }

    .card {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .06)
    }

    h1 {
      font-size: 20px;
      margin: 0 0 8px 0
    }

    .sub {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 14px
    }

    .grid {
      display: grid;
      gap: 12px
    }

    @media(min-width:640px) {
      .grid-2 {
        grid-template-columns: 1fr 1fr
      }
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px
    }

    input,
    select,
    button {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--ring);
      background: #fff;
      color: var(--text);
      outline: none;
      font-size: 16px;
      -webkit-appearance: none;
      appearance: none
    }

    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] button {
      background: #0b1222;
      color: var(--text)
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(239, 68, 68, .15)
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      flex-wrap: wrap;
      align-items: stretch;
      justify-content: space-between
    }

    .btn {
      cursor: pointer;
      font-weight: 600;
      letter-spacing: .3px;
      white-space: nowrap;
      flex: 1 1 140px;
      min-width: 120px
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border: none
    }

    .btn-ghost {
      background: transparent;
      color: var(--text)
    }

    .muted {
      color: var(--muted)
    }

    .small {
      font-size: 12px
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap
    }

    .result {
      margin-top: 14px;
      padding: 14px;
      border-radius: 14px;
      border: 1px dashed var(--ring);
      background: #fff
    }

    [data-theme="dark"] .result {
      background: #0b1327
    }

    .result h2 {
      margin: 0 0 10px 0;
      font-size: 16px
    }

    .result p {
      margin: 6px 0
    }

    .sep {
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--ring), transparent);
      margin: 14px 0
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f8fafc;
      border: 1px solid var(--ring);
      color: #374151;
      font-size: 11px
    }

    .stack {
      display: flex;
      flex-wrap: wrap;
      gap: 8px
    }

    .switch {
      display: inline-flex;
      align-items: center;
      gap: 8px
    }

    .switch input {
      width: auto
    }

    @media(max-width:480px) {
      .badge {
        font-size: 10px
      }

      .result {
        padding: 12px
      }

      .card {
        padding: 12px;
        border-radius: 12px
      }
    }

    @media print {
      body {
        background: #fff;
        padding: 0
      }

      .actions,
      .grid,
      .row .muted,
      .sub,
      #bestBox {
        display: none !important
      }

      .card {
        border: none;
        box-shadow: none;
        padding: 0
      }

      .result {
        border: none
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <h1>محاسبه‌گر وام و پس‌انداز</h1>
      <div class="sub">
        سپرده‌ها <b>بدون سود</b> در نظر گرفته شده‌اند. نرخ‌های وام: نیک‌وام ۴٪ (پیش‌فرض)، شایان ۱۴٪/۱۸٪/۲۳٪.
        <b>الزام طرح‌ها:</b> شایان = سپردهٔ یکجا؛ نیک‌وام = روزشمار (واریز پیش‌فرض: ابتدای ماه).
      </div>

      <div class="grid grid-2">
        <div>
          <label>طرح</label>
          <select id="plan">
            <option value="شایان">شایان</option>
            <option value="نیک وام" selected>نیک وام</option>
          </select>
        </div>
        <div>
          <label>واحد مبلغ</label>
          <select id="unitSel">
            <option value="toman" selected>تومان</option>
            <option value="rial">ریال</option>
          </select>
        </div>
        <div>
          <label>مبلغ وام (<span class="unitLabel">تومان</span>)</label>
          <input id="loan" inputmode="numeric" placeholder="مثلاً 120,000,000">
        </div>
        <div>
          <label>دورهٔ معدل‌گیری (ماه)</label>
          <select id="avgMonths"></select>
        </div>
        <div>
          <label>اقساط بازپرداخت (ماه)</label>
          <select id="repayMonths"></select>
        </div>
        <!-- فقط شایان -->
        <div id="typeWrap" style="display:none">
          <label>نوع تسهیلات (شایان)</label>
          <select id="loanType"></select>
        </div>
        <div id="aprWrap" style="display:none">
          <label>سود وام (%)</label>
          <select id="loanAprSel"></select>
        </div>
      </div>

      <div class="row">
        <span class="muted small">
          حداقل وام: <span class="badge">نیک‌وام ۳۰میلیون</span>
          <span class="badge">شایان ۵۰میلیون</span>
          <span class="badge">سپرده: بدون سود</span>
        </span>
        <div class="actions">
          <button class="btn btn-ghost" id="resetBtn">-reset-</button>
          <button class="btn btn-ghost" id="csvBtn">CSV جدول‌ها</button>
          <button class="btn btn-ghost" id="pdfBtn">خروجی PDF</button>
          <label class="switch"><input type="checkbox" id="themeToggle"> حالت تیره</label>
          <button class="btn btn-primary" id="calcBtn">محاسبه</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="stack small">
        <span class="badge" id="coefBadge">ضریب: -</span>
        <span class="badge" id="aprBadge">سود وام: -</span>
      </div>

      <div class="result" id="result" hidden>
        <h2>نتیجه</h2>
        <p id="minMsg" class="small" style="color:#fecaca" hidden></p>

        <p><span class="muted">معدل سپردهٔ لازم:</span>
          <b id="avgNeeded">-</b> <span class="unitLabel">تومان</span>
        </p>

        <p><span class="muted">قسط ماهانهٔ وام:</span>
          <b id="installment">-</b> <span class="unitLabel">تومان</span>
          <span class="small muted" id="aprInfo"></span>
        </p>
        <div class="sep"></div>
      </div>

      <div class="result" id="bestBox" hidden>
        <h2>پیشنهاد نهایی</h2>
        <p id="bestSummary">-</p>
        <p class="small muted" id="bestWhy"></p>
      </div>
    </div>
  </div>

  <script>
    'use strict';
    /* ===== داده‌ها ===== */
    const SCHEMES = [
      /* --- شایان (نمونه کامل) --- */
      { plan: "شایان", avg: 1, repay: 12, type: "مرابحه/جعاله", loanApr: 23, coef: 50 },
      { plan: "شایان", avg: 1, repay: 12, type: "کارت اعتباری", loanApr: 23, coef: 100 },
      { plan: "شایان", avg: 1, repay: 24, type: "کارت اعتباری", loanApr: 23, coef: 50 },
      { plan: "شایان", avg: 2, repay: 12, type: "مرابحه/جعاله", loanApr: 23, coef: 150 },
      { plan: "شایان", avg: 2, repay: 12, type: "کارت اعتباری", loanApr: 23, coef: 300 },
      { plan: "شایان", avg: 2, repay: 24, type: "مرابحه/جعاله", loanApr: 23, coef: 55 },
      { plan: "شایان", avg: 2, repay: 24, type: "کارت اعتباری", loanApr: 23, coef: 60 },
      { plan: "شایان", avg: 2, repay: 36, type: "جعاله", loanApr: 23, coef: 30 },
      { plan: "شایان", avg: 2, repay: 36, type: "اعتباری", loanApr: 23, coef: 35 },
      { plan: "شایان", avg: 3, repay: 12, type: "جعاله", loanApr: 23, coef: 200 },
      { plan: "شایان", avg: 3, repay: 12, type: "اعتباری", loanApr: 23, coef: 450 },
      { plan: "شایان", avg: 3, repay: 12, type: "جعاله", loanApr: 18, coef: 80 },
      { plan: "شایان", avg: 3, repay: 12, type: "اعتباری", loanApr: 18, coef: 100 },
      { plan: "شایان", avg: 3, repay: 24, type: "جعاله", loanApr: 23, coef: 80 },
      { plan: "شایان", avg: 3, repay: 24, type: "اعتباری", loanApr: 23, coef: 100 },
      { plan: "شایان", avg: 3, repay: 24, type: "جعاله", loanApr: 18, coef: 40 },
      { plan: "شایان", avg: 3, repay: 24, type: "اعتباری", loanApr: 18, coef: 50 },
      { plan: "شایان", avg: 3, repay: 36, type: "جعاله", loanApr: 23, coef: 50 },
      { plan: "شایان", avg: 3, repay: 36, type: "اعتباری", loanApr: 23, coef: 60 },
      { plan: "شایان", avg: 3, repay: 48, type: "جعاله", loanApr: 23, coef: 30 },
      { plan: "شایان", avg: 3, repay: 48, type: "اعتباری", loanApr: 23, coef: 35 },
      /* ۶ ماهه‌ها */
      { plan: "شایان", avg: 6, repay: 12, type: "اعتباری", loanApr: 14, coef: 130 },
      { plan: "شایان", avg: 6, repay: 12, type: "جعاله", loanApr: 14, coef: 110 },
      { plan: "شایان", avg: 6, repay: 12, type: "اعتباری", loanApr: 18, coef: 170 },
      { plan: "شایان", avg: 6, repay: 12, type: "جعاله", loanApr: 18, coef: 200 },
      { plan: "شایان", avg: 6, repay: 12, type: "اعتباری", loanApr: 23, coef: 220 },
      { plan: "شایان", avg: 6, repay: 12, type: "جعاله", loanApr: 23, coef: 285 },
      { plan: "شایان", avg: 6, repay: 24, type: "اعتباری", loanApr: 14, coef: 55 },
      { plan: "شایان", avg: 6, repay: 24, type: "جعاله", loanApr: 14, coef: 60 },
      { plan: "شایان", avg: 6, repay: 24, type: "اعتباری", loanApr: 18, coef: 70 },
      { plan: "شایان", avg: 6, repay: 24, type: "جعاله", loanApr: 18, coef: 75 },
      { plan: "شایان", avg: 6, repay: 24, type: "اعتباری", loanApr: 23, coef: 150 },
      { plan: "شایان", avg: 6, repay: 24, type: "جعاله", loanApr: 23, coef: 200 },
      { plan: "شایان", avg: 6, repay: 36, type: "اعتباری", loanApr: 18, coef: 45 },
      { plan: "شایان", avg: 6, repay: 36, type: "جعاله", loanApr: 18, coef: 50 },
      { plan: "شایان", avg: 6, repay: 36, type: "اعتباری", loanApr: 23, coef: 110 },
      { plan: "شایان", avg: 6, repay: 36, type: "جعاله", loanApr: 23, coef: 125 },
      { plan: "شایان", avg: 6, repay: 48, type: "اعتباری", loanApr: 23, coef: 90 },
      { plan: "شایان", avg: 6, repay: 48, type: "جعاله", loanApr: 23, coef: 75 },

      /* --- نیک‌وام ۴٪ --- */
      { plan: "نیک وام", avg: 1, repay: 12, type: "—", loanApr: 4, coef: 27 },
      { plan: "نیک وام", avg: 1, repay: 24, type: "—", loanApr: 4, coef: 15 },
      { plan: "نیک وام", avg: 1, repay: 36, type: "—", loanApr: 4, coef: 10 },
      { plan: "نیک وام", avg: 2, repay: 12, type: "—", loanApr: 4, coef: 55 },
      { plan: "نیک وام", avg: 2, repay: 24, type: "—", loanApr: 4, coef: 30 },
      { plan: "نیک وام", avg: 2, repay: 36, type: "—", loanApr: 4, coef: 20 },
      { plan: "نیک وام", avg: 2, repay: 48, type: "—", loanApr: 4, coef: 15 },
      { plan: "نیک وام", avg: 3, repay: 12, type: "—", loanApr: 4, coef: 80 },
      { plan: "نیک وام", avg: 3, repay: 24, type: "—", loanApr: 4, coef: 40 },
      { plan: "نیک وام", avg: 3, repay: 36, type: "—", loanApr: 4, coef: 30 },
      { plan: "نیک وام", avg: 3, repay: 48, type: "—", loanApr: 4, coef: 20 },
      { plan: "نیک وام", avg: 3, repay: 60, type: "—", loanApr: 4, coef: 15 },
      { plan: "نیک وام", avg: 4, repay: 12, type: "—", loanApr: 4, coef: 110 },
      { plan: "نیک وام", avg: 4, repay: 24, type: "—", loanApr: 4, coef: 55 },
      { plan: "نیک وام", avg: 4, repay: 36, type: "—", loanApr: 4, coef: 40 },
      { plan: "نیک وام", avg: 4, repay: 48, type: "—", loanApr: 4, coef: 30 },
      { plan: "نیک وام", avg: 4, repay: 60, type: "—", loanApr: 4, coef: 20 },
      { plan: "نیک وام", avg: 6, repay: 12, type: "—", loanApr: 4, coef: 160 },
      { plan: "نیک وام", avg: 6, repay: 24, type: "—", loanApr: 4, coef: 80 },
      { plan: "نیک وام", avg: 6, repay: 36, type: "—", loanApr: 4, coef: 60 },
      { plan: "نیک وام", avg: 6, repay: 48, type: "—", loanApr: 4, coef: 45 },
      { plan: "نیک وام", avg: 6, repay: 60, type: "—", loanApr: 4, coef: 30 },
      { plan: "نیک وام", avg: 12, repay: 12, type: "—", loanApr: 4, coef: 320 },
      { plan: "نیک وام", avg: 12, repay: 24, type: "—", loanApr: 4, coef: 160 },
      { plan: "نیک وام", avg: 12, repay: 36, type: "—", loanApr: 4, coef: 110 },
      { plan: "نیک وام", avg: 12, repay: 48, type: "—", loanApr: 4, coef: 80 },
      { plan: "نیک وام", avg: 12, repay: 60, type: "—", loanApr: 4, coef: 60 },
    ];
    const MIN_LOAN = { "نیک وام": 30000000, "شایان": 50000000 };

    /* ابزارها */
    function toEnglishDigits(str) { if (str == null) return ""; return String(str).replace(/[۰-۹]/g, d => "۰۱۲۳۴۵۶۷۸۹".indexOf(d)).replace(/[^0-9.]/g, ''); }
    function fmt(n) { return isFinite(n) ? n.toLocaleString('fa-IR', { maximumFractionDigits: 0 }) : "-"; }
    function formatCurrencyInput(el) { const raw = toEnglishDigits(el.value || "0"); const num = Number(raw); el.value = isFinite(num) ? num.toLocaleString('fa-IR', { maximumFractionDigits: 0 }) : ""; }
    const unitSel = document.getElementById('unitSel'); let currentUnit = 'toman';
    function unitIsRial() { return unitSel && unitSel.value === 'rial'; }
    function unitLabel() { return unitIsRial() ? 'ریال' : 'تومان'; }
    function fromInput(num) { return unitIsRial() ? (num / 10) : num; }
    function toDisplay(num) { return unitIsRial() ? (num * 10) : num; }
    function fmtMoney(n) { const v = toDisplay(n); return isFinite(v) ? fmt(Math.ceil(v)) : "-"; }
    function updateUnitLabels() { document.querySelectorAll('.unitLabel').forEach(el => el.textContent = unitLabel()); }
    function convertUnitFields(prev, nxt) {
      const prevRial = (prev === 'rial'), nxtRial = (nxt === 'rial');
      [loanInp].forEach(el => {
        if (!el) return; const raw = Number(toEnglishDigits(el.value || '0')); if (!isFinite(raw)) return;
        const baseToman = prevRial ? (raw / 10) : raw; const newShown = nxtRial ? (baseToman * 10) : baseToman;
        el.value = Number(newShown).toLocaleString('fa-IR', { maximumFractionDigits: 0 });
      });
      updateUnitLabels(); if (!resBox.hidden) calc();
    }

    /* عناصر DOM */
    const planSel = document.getElementById('plan');
    const loanInp = document.getElementById('loan');
    const avgSel = document.getElementById('avgMonths');
    const repaySel = document.getElementById('repayMonths');
    const typeWrap = document.getElementById('typeWrap');
    const typeSel = document.getElementById('loanType');
    const aprWrap = document.getElementById('aprWrap');
    const aprSel = document.getElementById('loanAprSel');
    const calcBtn = document.getElementById('calcBtn');
    const resetBtn = document.getElementById('resetBtn');
    const csvBtn = document.getElementById('csvBtn');
    const pdfBtn = document.getElementById('pdfBtn');
    const themeToggle = document.getElementById('themeToggle');

    const coefBadge = document.getElementById('coefBadge');
    const aprBadge = document.getElementById('aprBadge');
    const resBox = document.getElementById('result');
    const minMsg = document.getElementById('minMsg');
    const avgNeededEl = document.getElementById('avgNeeded');
    const installmentEl = document.getElementById('installment');
    const aprInfoEl = document.getElementById('aprInfo');

    const bestBox = document.getElementById('bestBox');
    const bestSummary = document.getElementById('bestSummary');
    const bestWhy = document.getElementById('bestWhy');

    /* فهرست‌ها */
    function populateAvg() {
      avgSel.innerHTML = ""; const p = planSel.value;
      const avgs = [...new Set(SCHEMES.filter(s => s.plan === p).map(s => s.avg))].sort((a, b) => a - b);
      avgs.forEach(a => { const o = document.createElement('option'); o.value = a; o.textContent = a; avgSel.appendChild(o); });
    }
    function populateRepay() {
      repaySel.innerHTML = ""; const p = planSel.value, a = Number(avgSel.value);
      const repays = [...new Set(SCHEMES.filter(s => s.plan === p && s.avg === a).map(s => s.repay))].sort((a, b) => a - b);
      repays.forEach(r => { const o = document.createElement('option'); o.value = r; o.textContent = r; repaySel.appendChild(o); });
    }
    function populateType() {
      const p = planSel.value, a = Number(avgSel.value), r = Number(repaySel.value);
      const types = [...new Set(SCHEMES.filter(s => s.plan === p && s.avg === a && s.repay === r).map(s => s.type))];
      typeSel.innerHTML = "";
      if (types.length === 1 && types[0] === "—") { typeWrap.style.display = "none"; }
      else { typeWrap.style.display = ""; types.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; typeSel.appendChild(o); }); }
      populateApr(); updateBadges();
    }
    function populateApr() {
      const p = planSel.value, a = Number(avgSel.value), r = Number(repaySel.value);
      const t = (typeWrap.style.display === "none") ? null : typeSel.value;
      const matches = SCHEMES.filter(s => s.plan === p && s.avg === a && s.repay === r && (t ? s.type === t : true));
      const aprs = [...new Set(matches.map(s => s.loanApr).filter(v => v != null))].sort((x, y) => x - y);
      aprSel.innerHTML = "";
      if (aprs.length === 0) { aprWrap.style.display = "none"; }
      else { aprWrap.style.display = ""; aprs.forEach(v => { const o = document.createElement('option'); o.value = String(v); o.textContent = v; aprSel.appendChild(o); }); }
    }
    function getSelectedScheme() {
      const p = planSel.value, a = Number(avgSel.value), r = Number(repaySel.value);
      const t = (typeWrap.style.display === "none") ? "—" : typeSel.value;
      const apr = (aprWrap.style.display === "none") ? null : Number(aprSel.value);
      const pool = SCHEMES.filter(s => s.plan === p && s.avg === a && s.repay === r && s.type === t);
      if (apr != null && !Number.isNaN(apr)) { const m = pool.find(s => s.loanApr === apr); if (m) return m; }
      return pool[0];
    }
    function updateBadges() {
      const s = getSelectedScheme();
      coefBadge.textContent = s ? `ضریب: ${s.coef}%` : "ضریب: -";
      const aprTxt = (s && s.loanApr != null) ? `${s.loanApr}%` : (aprSel.value || "-");
      aprBadge.textContent = `سود وام: ${aprTxt}`;
    }

    /* محاسبات پایه */
    function calcInstallment(loan, aprPercent, months) {
      const n = Number(months) || 0, r = (Number(aprPercent) || 0) / 1200;
      if (!n) return NaN; if (r === 0) return loan / n;
      const pow = Math.pow(1 + r, n); return loan * r * pow / (pow - 1);
    }

    /* پیشنهاد نهایی (B0=0) */
    function buildFinalSuggestion(loan) {
      // میانگین لازم برای هر طرح:
      // avgNeeded = loan / (coef/100)
      const candidates = SCHEMES
        .filter(s => loan >= (MIN_LOAN[s.plan] || 0))
        .map(s => {
          const avgNeeded = loan / (s.coef / 100);
          if (s.plan === 'نیک وام') {
            // واریز ابتدای ماه و B0=0 ⇒ P = 2*avgNeeded/(n+1)
            const P = (2 * avgNeeded) / (s.avg + 1);
            return { kind: 'nik', s, avgNeeded, monthly: P };
          } else {
            // شایان: سپردهٔ ثابت از روز اول
            return { kind: 'shayan', s, avgNeeded, lump: avgNeeded };
          }
        });

      if (!candidates.length) return null;

      // رتبه‌بندی: کمترین avgNeeded ← سود کمتر ← دوره معدل‌گیری کوتاه‌تر ← بازپرداخت کوتاه‌تر
      candidates.sort((a, b) =>
        (a.avgNeeded - b.avgNeeded) ||
        ((a.s.loanApr || 0) - (b.s.loanApr || 0)) ||
        (a.s.avg - b.s.avg) ||
        (a.s.repay - b.s.repay)
      );

      return candidates[0];
    }

    function calc() {
      const plan = planSel.value;
      const loan = fromInput(Number(toEnglishDigits(loanInp.value || "0")));
      const s = getSelectedScheme();
      resBox.hidden = false; minMsg.hidden = true;
      if (!s) { avgNeededEl.textContent = "-"; installmentEl.textContent = "-"; aprInfoEl.textContent = ""; bestBox.hidden = true; return; }

      const minLoan = MIN_LOAN[plan] || 0;
      if (loan < minLoan) { minMsg.hidden = false; minMsg.textContent = `حداقل مبلغ وام برای «${plan}» ${fmtMoney(minLoan)} ${unitLabel()} است.`; }

      const avgNeeded = loan / (s.coef / 100);
      avgNeededEl.textContent = fmtMoney(avgNeeded);

      const apr = (s && s.loanApr != null) ? Number(s.loanApr) : 0;
      const inst = calcInstallment(loan, apr, s.repay);
      if (isFinite(inst)) {
        installmentEl.textContent = fmtMoney(Math.ceil(inst));
        aprInfoEl.textContent = `| سود سالانه ${apr}% → ماهانه ${(apr / 12).toFixed(3)}% | اقساط ${s.repay}‌ماهه`;
      } else { installmentEl.textContent = "-"; aprInfoEl.textContent = ""; }

      // پیشنهاد نهایی بر اساس مبلغ وام با B0=0
      const best = buildFinalSuggestion(loan);
      if (best) {
        bestBox.hidden = false;
        if (best.kind === 'nik') {
          bestSummary.textContent = `پیشنهاد: نیک‌وام — ${best.s.avg} ماه معدل‌گیری، بازپرداخت ${best.s.repay} ماه @ ${best.s.loanApr}%`;
          bestWhy.textContent = `برای رسیدن به میانگین لازم بدون سپردهٔ اولیه، واریز ماهانهٔ حدود ${fmtMoney(best.monthly)} ${unitLabel()} (ابتدای هر ماه) نیاز است.`;
        } else {
          bestSummary.textContent = `پیشنهاد: شایان — ${best.s.avg} ماه معدل‌گیری، بازپرداخت ${best.s.repay} ماه، نوع ${best.s.type} @ ${best.s.loanApr}%`;
          bestWhy.textContent = `برای واجد شرایط شدن باید از امروز سپردهٔ ثابتِ حدود ${fmtMoney(best.lump)} ${unitLabel()} نگه دارید.`;
        }
      } else {
        bestBox.hidden = false;
        bestSummary.textContent = 'برای مبلغ واردشده ترکیبی پیدا نشد.';
        bestWhy.textContent = 'حداقل وام نیک‌وام ۳۰میلیون و شایان ۵۰میلیون است.';
      }

      updateBadges(); updateUnitLabels();
    }

    function resetForm() {
      loanInp.value = ""; resBox.hidden = true; minMsg.hidden = true;
      avgNeededEl.textContent = "-"; installmentEl.textContent = "-"; aprInfoEl.textContent = "";
      bestBox.hidden = true; bestSummary.textContent = "-"; bestWhy.textContent = "";
    }

    /* CSV (لیست طرح‌ها) */
    function downloadCSV() {
      const header = ['plan', 'avg_months', 'repay_months', 'type', 'loan_apr', 'coef'];
      const rows = [header].concat(SCHEMES.map(s => [s.plan, s.avg, s.repay, s.type, s.loanApr, s.coef]));
      const lines = rows.map(r => r.map(v => '"' + String(v == null ? '' : v).replace(/"/g, '""') + '"').join(',')).join('\r\n');
      const csvText = 'sep=,\r\n' + lines;
      function toUTF16LEWithBOM(str) {
        const buf = new ArrayBuffer((str.length + 1) * 2); const view = new DataView(buf);
        view.setUint16(0, 0xFEFF, true); for (let i = 0; i < str.length; i++) { view.setUint16(2 + i * 2, str.charCodeAt(i), true); }
        return buf;
      }
      const blob = new Blob([toUTF16LEWithBOM(csvText)], { type: 'text/csv;charset=utf-16le;' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = 'loan_schemes.csv'; document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    }

    /* رویدادها */
    function updateAll() { populateAvg(); populateRepay(); populateType(); updateBadges(); }
    planSel.addEventListener('change', updateAll);
    avgSel.addEventListener('change', () => { populateRepay(); populateType(); updateBadges(); });
    repaySel.addEventListener('change', () => { populateType(); updateBadges(); });
    typeSel.addEventListener('change', () => { populateApr(); updateBadges(); });
    aprSel.addEventListener('change', updateBadges);
    calcBtn.addEventListener('click', calc);
    resetBtn.addEventListener('click', resetForm);
    csvBtn.addEventListener('click', downloadCSV);
    pdfBtn.addEventListener('click', () => window.print());
    loanInp.addEventListener('input', () => formatCurrencyInput(loanInp));
    unitSel.addEventListener('change', () => { const prev = currentUnit; const next = unitSel.value; convertUnitFields(prev, next); currentUnit = next; });

    const root = document.documentElement;
    const themeToggleEl = document.getElementById('themeToggle'); // نام را عوض کردم تا با نسخه‌های قبلی تداخل نکند
    if (themeToggleEl) {
      themeToggleEl.addEventListener('change', () => {
        themeToggleEl.checked ? root.setAttribute('data-theme', 'dark')
          : root.removeAttribute('data-theme');
      });
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        themeToggleEl.checked = true;
        root.setAttribute('data-theme', 'dark');
      }
    }
    /* init */
    updateAll(); currentUnit = unitSel ? unitSel.value : 'toman'; updateUnitLabels();
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
    }
  </script>
</body>

</html>